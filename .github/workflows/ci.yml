name: CI

on:
    push:
        branches: [ develop, main ]
    pull_request:
        branches: [ develop, main ]

permissions:
    contents: write
    pages: write
    id-token: write

jobs:
    lint-build-test:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [ 20, 22 ]

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v4

            -   name: Setup Node.js ${{ matrix.node-version }}
                uses: actions/setup-node@v4
                with:
                    node-version: ${{ matrix.node-version }}
                    cache: 'npm'

            -   name: Clear Vitest cache
                run: rm -rf node_modules/.vitest node_modules/.vite coverage

            -   name: Install dependencies
                run: npm ci

            -   name: Run ESLint
                run: npm run lint

            -   name: Run TypeScript check
                run: npx tsc --noEmit

            -   name: Build project
                run: npm run build

            -   name: Run Vitest with coverage
                run: npx vitest run --coverage

            -   name: Set safe artifact name
                id: artifact_name
                run: |
                    SAFE_REF_NAME=$(echo "${GITHUB_REF_NAME}" | tr '/:' '-' )
                    echo "safe_ref_name=$SAFE_REF_NAME" >> $GITHUB_OUTPUT

            # Upload coverage only for Node 22
            -   name: Upload coverage artifact
                if: matrix.node-version == 22
                uses: actions/upload-artifact@v4
                with:
                    name: coverage-report-${{ steps.artifact_name.outputs.safe_ref_name }}-${{ github.run_id }}
                    path: coverage/
                    retention-days: 7

    all-checks-passed:
        runs-on: ubuntu-latest
        needs: lint-build-test
        if: success()
        steps:
            -   name: âœ… Report success
                run: echo "All checks passed successfully!"

    deploy-coverage:
        runs-on: ubuntu-latest
        needs: lint-build-test
        if: success()
        permissions:
            contents: write
            pages: write
            id-token: write
            pull-requests: write

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v4

            -   name: Set safe artifact name
                id: artifact_name
                run: |
                    SAFE_REF_NAME=$(echo "${GITHUB_REF_NAME}" | tr '/:' '-' )
                    echo "safe_ref_name=$SAFE_REF_NAME" >> $GITHUB_OUTPUT

            -   name: Download coverage artifact
                uses: actions/download-artifact@v4
                with:
                    name: coverage-report-${{ steps.artifact_name.outputs.safe_ref_name }}-${{ github.run_id }}
                    path: coverage/

            -   name: Determine publish folder
                id: publish
                run: |
                    if [[ "${GITHUB_REF}" == refs/pull/* ]]; then
                        PR_NUMBER=$(echo "${GITHUB_REF}" | cut -d'/' -f3)
                        SAFE_BRANCH_NAME="pr-${PR_NUMBER}"
                    else
                        SAFE_BRANCH_NAME=$(echo "${GITHUB_REF_NAME}" | tr '/:' '-' )
                    fi
                    echo "safe_branch_name=$SAFE_BRANCH_NAME" >> $GITHUB_OUTPUT
                    echo "Publishing as: $SAFE_BRANCH_NAME"

            -   name: Prepare branch-specific folder
                run: |
                    mkdir -p "publish/${{ steps.publish.outputs.safe_branch_name }}"
                    mv coverage/lcov-report/* "publish/${{ steps.publish.outputs.safe_branch_name }}/"
                    echo "Report will be published at /${{ steps.publish.outputs.safe_branch_name }}/"


            -   name: Upload Pages artifact
                uses: actions/upload-pages-artifact@v3
                with:
                    path: publish/

            -   name: Deploy to GitHub Pages
                id: deployment
                uses: actions/deploy-pages@v4

            -   name: Comment coverage link on PR
                if: github.event_name == 'pull_request'
                uses: marocchino/sticky-pull-request-comment@v2
                with:
                    header: "Test Coverage Report"
                    message: |
                        âœ… Coverage report successfully generated!
                        ðŸ”— **View it here:**
                        ðŸ‘‰ [${{ github.repository }} â€” coverage report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ steps.publish.outputs.safe_branch_name }}/index.html)
