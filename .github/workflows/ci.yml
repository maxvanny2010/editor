name: CI

on:
    push:
        branches: [ develop, main ]
    pull_request:
        branches: [ develop, main ]

permissions:
    contents: write
    pages: write
    id-token: write

jobs:

    lint-build-test:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v4

            -   uses: actions/setup-node@v4
                with:
                    node-version: 22
                    cache: npm

            -   run: rm -rf node_modules/.vite node_modules/.vitest coverage
            -   run: npm ci
            -   run: npm run lint
            -   run: npx tsc --noEmit
            -   run: npm run build
            -   env:
                    VITE_ENV: test
                run: npm run test:ci

            -   id: ref
                run: echo "value=${GITHUB_REF_NAME//[\/:]/-}" >> $GITHUB_OUTPUT

            -   uses: actions/upload-artifact@v4
                with:
                    name: coverage-${{ steps.ref.outputs.value }}-${{ github.run_id }}
                    path: coverage/
                    retention-days: 7


    deploy-coverage:
        runs-on: ubuntu-latest
        needs: lint-build-test
        if: success()
        environment:
            name: github-pages
            url: https://maxvanny2010.github.io/editor/
        permissions:
            contents: write
            pages: write
            id-token: write
            pull-requests: write

        steps:
            -   uses: actions/checkout@v4

            -   id: ref
                run: echo "value=${GITHUB_REF_NAME//[\/:]/-}" >> $GITHUB_OUTPUT

            -   uses: actions/download-artifact@v4
                with:
                    name: coverage-${{ steps.ref.outputs.value }}-${{ github.run_id }}
                    path: coverage/

            -   id: folder
                run: |
                    if [[ "$GITHUB_REF" == refs/pull/* ]]; then
                      echo "value=pr-$(echo "$GITHUB_REF" | cut -d'/' -f3)" >> $GITHUB_OUTPUT
                    else
                      echo "value=${GITHUB_REF_NAME//[\/:]/-}" >> $GITHUB_OUTPUT
                    fi

            -   run: |
                    mkdir -p publish/${{ steps.folder.outputs.value }}
                    mv coverage/lcov-report/* publish/${{ steps.folder.outputs.value }}/

            -   uses: actions/upload-pages-artifact@v3
                with:
                    path: publish/
                    name: coverage-pages-${{ github.run_id }}-${{ steps.folder.outputs.value }}

            -   uses: actions/deploy-pages@v4
                with:
                    artifact_name: coverage-pages-${{ github.run_id }}-${{ steps.folder.outputs.value }}


    deploy-app:
        runs-on: ubuntu-latest
        needs: lint-build-test
        if: github.ref == 'refs/heads/main' && success()
        environment:
            name: github-pages
            url: https://maxvanny2010.github.io/editor/
        permissions:
            contents: write
            pages: write
            id-token: write

        steps:
            -   uses: actions/checkout@v4

            -   uses: actions/setup-node@v4
                with:
                    node-version: 22
                    cache: npm

            -   run: npm ci
            -   run: npm run build

            -   uses: actions/upload-pages-artifact@v3
                with:
                    path: dist/
                    name: app-pages-${{ github.run_id }}-main

            -   uses: actions/deploy-pages@v4
                with:
                    artifact_name: app-pages-${{ github.run_id }}-main
